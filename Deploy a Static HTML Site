import boto3
import argparse
from datetime import datetime, timedelta, timezone
from prettytable import PrettyTable
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText

# Thresholds
UTILIZATION_THRESHOLD = 25  # Show FSx file systems with less than 25% utilization
AGE_THRESHOLD_DAYS = 7

# Email Configuration
SENDER_EMAIL = 'your_email@example.com'
RECIPIENT_EMAIL = 'recipient@example.com'

def get_fsx_filesystems(fsx_client):
    """Get all FSx ONTAP file systems."""
    filesystems = []
    paginator = fsx_client.get_paginator('describe_file_systems')
    for page in paginator.paginate():
        filesystems.extend(page['FileSystems'])
    return filesystems

def get_file_system_utilization(cloudwatch_client, fs_id):
    """Fetch storage utilization of an FSx file system from CloudWatch."""
    end_time = datetime.utcnow()
    start_time = end_time - timedelta(days=7)
    
    response = cloudwatch_client.get_metric_statistics(
        Namespace='AWS/FSx',
        MetricName='StorageCapacityUtilization',
        Dimensions=[{'Name': 'FileSystemId', 'Value': fs_id}],
        StartTime=start_time,
        EndTime=end_time,
        Period=86400,
        ExtendedStatistics=['p50']
    )

    if response['Datapoints']:
        utilization = response['Datapoints'][0]['p50']
        print(f"FSx FileSystem {fs_id} Utilization: {utilization}%")  # Debugging output
        return utilization
    return None

def get_volume_utilization(cloudwatch_client, volume_id):
    """Fetch storage utilization of an FSx ONTAP volume from CloudWatch."""
    end_time = datetime.utcnow()
    start_time = end_time - timedelta(days=7)
    
    response = cloudwatch_client.get_metric_statistics(
        Namespace='AWS/FSx',
        MetricName='StorageCapacityUtilization',
        Dimensions=[{'Name': 'VolumeId', 'Value': volume_id}],
        StartTime=start_time,
        EndTime=end_time,
        Period=86400,
        ExtendedStatistics=['p50']
    )

    if response['Datapoints']:
        utilization = response['Datapoints'][0]['p50']
        print(f"Volume {volume_id} Utilization: {utilization}%")  # Debugging
        return utilization
    return None

def get_volumes(fsx_client, cloudwatch_client, fs_id):
    """Get all volumes of an FSx ONTAP file system and their storage utilization."""
    volumes = []
    paginator = fsx_client.get_paginator('describe_volumes')

    for page in paginator.paginate(Filters=[{'Name': 'file-system-id', 'Values': [fs_id]}]):
        for volume in page['Volumes']:
            vol_id = volume['VolumeId']
            vol_name = volume['Name']
            vol_size = volume['CapacityAllocation']['StorageCapacity']
            
            utilization = get_volume_utilization(cloudwatch_client, vol_id)

            volumes.append({
                'VolumeId': vol_id,
                'Name': vol_name,
                'Size': vol_size,
                'Utilization': f"{utilization:.2f}%" if utilization is not None else "N/A"
            })
    return volumes

def generate_report(fsx_client, cloudwatch_client):
    """Generate FSx ONTAP utilization report."""
    filesystems = get_fsx_filesystems(fsx_client)
    report = []

    for fs in filesystems:
        if fs['FileSystemType'] == 'ONTAP':
            fs_id = fs['FileSystemId']
            creation_time = fs['CreationTime']
            age = (datetime.now(timezone.utc) - creation_time).days

            if age > AGE_THRESHOLD_DAYS:
                utilization = get_file_system_utilization(cloudwatch_client, fs_id)
                
                if utilization is not None and utilization < UTILIZATION_THRESHOLD:
                    volumes = get_volumes(fsx_client, cloudwatch_client, fs_id)  # Fetch volumes & utilization
                    report.append({
                        'FileSystemId': fs_id,
                        'CreationTime': creation_time.strftime("%Y-%m-%d %H:%M:%S"),
                        'Utilization': f"{utilization:.2f}%",
                        'Volumes': volumes
                    })

    return report

def create_html_table(report):
    """Generate HTML tables for each file system."""
    html_content = "<h2>FSx ONTAP Utilization Report</h2>"

    for fs in report:
        html_content += f"<h3>FileSystem ID: {fs['FileSystemId']}</h3>"
        html_content += f"<p><strong>Creation Time:</strong> {fs['CreationTime']}<br>"
        html_content += f"<strong>Utilization:</strong> {fs['Utilization']}</p>"

        # Table for Volumes
        table = PrettyTable()
        table.field_names = ["Volume ID", "Volume Name", "Size (GB)", "Utilization"]

        for vol in fs['Volumes']:
            table.add_row([vol['VolumeId'], vol['Name'], vol['Size'], vol['Utilization']])

        html_content += table.get_html_string()
        html_content += "<br>"

    return html_content

def send_email(html_content):
    """Send the report as an HTML email using localhost SMTP."""
    msg = MIMEMultipart('alternative')
    msg['Subject'] = "FSx ONTAP Utilization Report"
    msg['From'] = SENDER_EMAIL
    msg['To'] = RECIPIENT_EMAIL

    part = MIMEText(html_content, 'html')
    msg.attach(part)

    with smtplib.SMTP('localhost') as server:
        server.sendmail(SENDER_EMAIL, RECIPIENT_EMAIL, msg.as_string())

def main():
    parser = argparse.ArgumentParser(description="FSx ONTAP Utilization Report")
    parser.add_argument('--region', required=True, help="AWS region (e.g., us-east-1)")
    args = parser.parse_args()
    region = args.region

    fsx_client = boto3.client('fsx', region_name=region)
    cloudwatch_client = boto3.client('cloudwatch', region_name=region)

    report = generate_report(fsx_client, cloudwatch_client)
    if report:
        html_table = create_html_table(report)
        send_email(html_table)
        print("Report sent successfully.")
    else:
        print("No file systems below utilization threshold.")

if __name__ == "__main__":
    main()

